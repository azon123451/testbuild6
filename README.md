# Магазинный операторский чат-бот

Telegram-бот на `aiogram`, который:

- принимает сообщения клиентов;
- распределяет их между операторами (по PIN-коду и лимиту одновременных чатов);
- ставит в очередь и отправляет автоответы, если обе линии заняты;
- хранит историю локально в SQLite и показывает её только операторам (команда `/history`).

## Структура

- `bot/` — вся логика бота: операторы, очередь, FAQ, локальное хранилище (SQLAlchemy).
- `shared/` — общие перечисления, которые используются в нескольких модулях.
- `infra/` — Dockerfile/compose для запуска одного процесса бота.
- `data/` — каталог для SQLite (`support.db`). В репозитории лежит только `.gitkeep`, сама база игнорируется.

## Быстрый старт (Windows)

```bash
copy env.example .env
python -m venv .venv
. .venv/Scripts/activate
pip install -r requirements.txt
python -m bot.main
```

Файл `.env` содержит:

- `TELEGRAM_BOT_TOKEN` — токен, полученный у BotFather;
- `OPERATOR_PINS` — список PIN-кодов через запятую;
- `DATABASE_URL` — где хранить SQLite (по умолчанию `sqlite:///./data/support.db`);
- `HISTORY_LIMIT`, `AUTO_REPLY_*`, прочие лимиты.

## Работа бота

1. Клиент отправляет сообщение — бот пытается привязать его к свободному оператору.
2. Нет свободных операторов → клиент попадает в очередь и получает автоответ + быстрый FAQ, если найден похожий вопрос.
3. Оператор авторизуется командой `/operator <PIN>`, выбирает клиента `/next` или `/use <id>`, отвечает обычными сообщениями.
4. `/done [client_id]` завершает диалог, клиент получает финальное сообщение, сессия закрывается.
5. `/history <client_id> [limit]` показывает историю переписки (только для операторов).

## Ограничения

- Запрет на скриншоты в Telegram невозможен программно. Мы лишь ставим `protect_content=True`, чтобы нельзя было переслать сообщение.
- Локальная SQLite подходит для одного экземпляра бота. Для высокой нагрузки можно указать внешний Postgres (`DATABASE_URL=postgresql+psycopg://...`) — SQLAlchemy поддерживает.

## Дальнейшие шаги

- Расширить FAQ или подключить LLM для более умных автоответов.
- Добавить веб-интерфейс для операторов (например, на Streamlit/Gradio) поверх той же базы.
- Добавить уведомления/метрики (например, счётчик ожидания очереди и алерты в Telegram).
