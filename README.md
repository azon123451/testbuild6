# Telegram оператор-бот для магазина

Готовый Telegram‑бот помогает операторам магазина общаться с клиентами в личных чатах. Бот автоматически распределяет входящие запросы между свободными операторами и позволяет им вести несколько диалогов одновременно с помощью удобных команд.

## Возможности
- автоматическое назначение клиента на свободного оператора;
- уведомления операторов о новых диалогах;
- ручное управление статусами: `available`, `busy`, `offline`;
- команды `/focus`, `/reply`, `/end` для работы с несколькими клиентами;
- журнал операторов и активных диалогов хранится в JSON внутри папки `data`.

## Требования
- Python 3.12+
- токен Telegram бота (получается у [@BotFather](https://t.me/BotFather))

## Установка
```bash
python -m venv .venv
.venv\Scripts\activate           # Windows PowerShell
pip install -r requirements.txt
copy env.example .env            # заполните TELEGRAM_BOT_TOKEN и OPERATOR_SECRET
```

## Запуск
```bash
setx TELEGRAM_BOT_TOKEN "<ваш токен>"
setx OPERATOR_SECRET "<секрет для операторов>"
python -m src.bot
```

Или экспортируйте переменные в `.env` и используйте [python-dotenv](https://pypi.org/project/python-dotenv/) — файл `env.example` показывает формат.

## Как работает
1. Клиент пишет любое сообщение боту.
2. Бот ищет свободного (`/available`) оператора и назначает ему клиента.
3. Оператор получает уведомление и может:
   - `/focus <client_id>` — выбрать активный диалог, чтобы писать без команд;
   - `/reply <client_id> <текст>` — отправить разовое сообщение клиенту;
   - `/clients` — посмотреть всех закреплённых клиентов;
   - `/end <client_id>` — завершить диалог и освободить клиента;
   - `/available`, `/busy`, `/offline` — переключить статус для распределения новых запросов;
   - `/status` — посмотреть свой текущий статус и список клиентов.

Все входящие и исходящие сообщения пересылаются оператору/клиенту с помощью `copy_message`, поэтому передаются любые форматы (текст, фото, документы, голосовые и т.д.).

## Структура проекта
```
BOT4/
├─ requirements.txt        # зависимости
├─ env.example             # пример переменных окружения
├─ data/                   # JSON‑файлы с операторами и диалогами
└─ src/
   ├─ bot.py               # точка входа, Telegram handlers
   ├─ config.py            # загрузка настроек из окружения
   ├─ managers.py          # логика операторов и диалогов
   └─ storage.py           # helper для JSON‑хранилищ
```

## Советы по эксплуатации
- Секретную фразу (`OPERATOR_SECRET`) держите в тайне — без неё нельзя зарегистрироваться оператором.
- Для продакшн‑развёртывания используйте процесс‑менеджер (systemd, pm2, docker) и добавьте HTTPS‑прокси, если планируете использовать webhook вместо polling.
- Папку `data/` можно вынести на общий сетевой диск, если бота запускают несколько экземпляров (но тогда стоит заменить JSON на БД).

Готово! После запуска бот сразу готов принимать клиентов. Операторам достаточно выполнить `/register <секрет>` в личном чате с ботом и выставить статус `/available`.

