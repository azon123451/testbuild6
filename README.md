# Магазинный операторский чат-бот

Реализует Telegram-бота для общения магазина с клиентами и отдельный FastAPI-бэкенд, который хранит историю переписки и предоставляет приватный доступ только операторам.

## Состав

- `bot/` — Telegram бот на `aiogram`. Управляет очередью клиентов, назначает операторов, отправляет автоответы, пишет историю в бэкенд.
- `backend/` — FastAPI + SQLAlchemy. Хранит чаты в SQLite (по умолчанию) и отдаёт историю только после проверки операторского токена.
- `shared/` — общие перечисления и pydantic-схемы.
- `infra/` — `docker-compose.yml` для одновременного запуска бота, API и базы.

## Быстрый старт

```bash
copy env.example .env   # Windows
python -m venv .venv
. .venv/Scripts/activate
pip install -r requirements.txt
```

### Локальный запуск (из корня репозитория)

```bash
uvicorn backend.main:app --reload --app-dir backend

# в отдельном терминале
python -m bot.main
```

Параметры читаются из `.env`: токен Telegram, пины операторов, URL бэкенда и т. д.

## Поток обработки чатов

1. Клиент пишет боту в Telegram.
2. Бот ищет свободного оператора (у каждого ограничение на количество одновременных диалогов).
3. Если операторов нет — клиент становится в очередь и мгновенно получает автоответ.
4. Когда оператор освобождается, бот связывает его с первым клиентом из очереди и дублирует историю.
5. Все сообщения логируются в бэкенд *только* под операторским токеном, чтобы клиенты не видели историю.

## Ограничения

- Telegram не даёт запретить скриншоты. Ограничить можно только пересылку (`protect_content=True`), что и делает бот.
- Для продакшена рекомендуется вынести SQLite в Postgres и добавить Redis для статусов и очередей.

## Дальнейшие шаги

- Дополнить FAQ-автоответы собственной базой знаний или LLM.
- Добавить веб-панель для операторов поверх FastAPI (WebSocket + React).
- Настроить CI/CD и мониторинг (SLA по ответам, алерты при превышении очереди).

